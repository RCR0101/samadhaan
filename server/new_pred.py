import pandas as pd
from nltk.corpus import stopwords
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import GradientBoostingClassifier, RandomForestClassifier
from sklearn.pipeline import Pipeline
from sklearn.model_selection import GridSearchCV
from datetime import datetime

from common_func import clean_text
ini_date = datetime.now()
def set_new_predict_pipe():
    df = pd.read_csv(f'output_csv/updated_post_csv-small-1.csv')

    # df['Text'].fillna('missing', inplace=True)
    # df['Depts'].fillna('missing', inplace=True)

    # df.to_csv(f'output_csv/updated_post_csv2.csv', index=False)

    texts = df['Text']  # Column containing text data
    depts = df['Depts']   # Column containing the labels

    # Create a pipeline for text classification
    pipeline = Pipeline([
    ("cv", CountVectorizer()),
    ("clf", GradientBoostingClassifier())
    ])

    # param_grid = {
    # "cv__ngram_range": [(1, 1), (1, 2)],
    # "clf__learning_rate": [0.1, 0.01],
    # "clf__max_depth": [3, 5],
    # "clf__min_samples_split": [2, 4],
    # "clf__subsample": [0.8, 0.9]
    # }
    param_grid = {
    "cv__ngram_range": [(1, 1)],
    "clf__learning_rate": [0.05],
    "clf__max_depth": [3],
    "clf__min_samples_split": [2],
    "clf__subsample": [0.8],
    "clf__loss": ["log_loss"],
    "clf__n_estimators": [100],
    "clf__max_features": [None,"sqrt"]
} # 3.503332 seconds 

    # Perform grid search to find the best hyperparameters
    grid_search = GridSearchCV(pipeline, param_grid, cv=5)
    grid_search.fit(texts, depts)

    # Return the best estimator
    return grid_search.best_estimator_

# new code


# new_text = "telecommunication mobile related activationdeactivationfault sim card mobile number x4x7x2x3x2 service provider bharat sanchar nigam limited corporate office respected sir reference issue faced would like lodge complaint bsnl kalyani exchange wherein issued duplicate sim mother39s name aruna chakraborty without permission knowledge hence would like register complaint would like necessary action taken bsnl kalyani exchange carried transaction issuance sim card 17th dec 2022 confirmed bsnl customer care said date following number x4x7x2x3x2 would also like inform taking legal action mistake issuing sim without verifying detail caused financial fraud saving account 19th dec 2022 amounting rs1374000 also went kalyani bsnl exchange 22nd dec shared document duplicate sim issued looking could clearly see document fake verified bsnl official also attaching fake document received exchange used issue sim card along original document regard anita rao chakraborty alternate contact x0x1x4x0x7 x0x3x6x4x4 x2x2x2x4x5"
# new_text = "Allegations of corruption in MGNREGA schemes"
# # new_complaint_text  = "My INDIAN Passport number: X7X3X4X0 \r\n\r\nMy Immigration Newzealand client number: X3X2X0X4 \r\n\r\n\r\n\r\n\r\n\r\n\r\nI Danapuneni Sreekanth Rao,I paid fee to the college,and I paid taxes to New-Zealand Government in 2009 year.without provided any services how they took my tution fee?all these things because of New-Zealand Government iam facing health problems.why they took my tution fee,without provided anything.due to loss of my 11years I should get permanent residency and compensation of New-Zealand dollars 913336 NZD.all my friends are in good position in jobs.iam mentally faced lot of problems because of New-Zealand Government.So I should get permanent residency and compensation of New-Zealand dollars 913336 NZD from Indian Government. \r\n\r\n\r\n\r\n\r\n\r\nBank Details: \r\nACCOUNT NAME: Sreekanth Rao Danapuneni \r\n\r\nACCOUNT NO: X2X8X8X9X8X \r\n\r\nIFSC CODE: X-X-X-X-X \r\n\r\nBANK: STATE BANK OF INDIA \r\n\r\nBRANCH:MANTHANI \r\nSTATE. : TELANGANA \r\nCOUNTRY :. INDIA \r\n\r\n\r\nThanks and regards \r\n----------------------- \r\nDanapuneni Sreekanth Rao"
# # new_text  =  "Petroleum and Natural Gas >> PNG related >> Others\r\n\r\nCity Gas Distribution (CGD) entity : Indraprastha Gas Limited\r\nBP number : X0X1X0X9X5\r\nGeographical Area Name : 56 ASHIRWAAD APARTMENT,MAYUR VIHAR PHASE-3,EAST DELHI-110096\r\n-----------------------\r\nDear Sir Madam\r\n\r\nOne technician visited my premises for IGL unauthorized gas pipeline shifting from my house&#39;s back side entrance gate.\r\nIn this connection, I kindly request IGL to arrange to shift the unauthorized main IGL gas pipeline from inside the back entrance gate of my flat 56  Ashirvad Apartment Mayur Vihar Phase-3 Delhi at the earliest for which I shall be grateful to you.\r\n\r\nKindly note this is once again a Prior Intimation as per the rule, if the appropriate action is not taken by IGL for an unauthorized gas pipeline shifting which is installed at my flat gate, I will be forced to take necessary action.\r\nIn view of the above, I seek your good office intervention  in the matter since I have been requesting IGL to shift the main gas pipeline from my house&#39;s backside entrance  gate \r\n\r\nBest Regards\r\nBhajan Singh Rauthan\r\n56 Ashirvad Apartment\r\nMayur Vihar Phase-3,\r\nDelhi-110096"
# # new_complaint_text  =  "Home Affairs >> Complaint for security agencies >> Complaint against state police excluding IPS & UT police\r\n\r\nName and designation of the officer against which the complaint is made : \u0926\u0947\u0935\u0947\u0902\u0926\u094d\u0930 \u0938\u093f\u0902\u0939 \u0927\u0941\u0930\u094d\u0935\u0947 \u0928\u0917\u0930 \u092a\u0941\u0932\u093f\u0938 \u0905\u0927\u0940\u0915\u094d\u0937\u0915 \u0927\u093e\u0930\r\n-----------------------\r\n\u092e\u093e\u0928\u0928\u0940\u092f \u092a\u094d\u0930\u0927\u093e\u0928\u092e\u0902\u0924\u094d\u0930\u0940 \u092e\u0939\u094b\u0926\u092f \u0928\u093f\u0935\u0947\u0926\u0928 \u0939\u0948 \u0915\u093f \u0928\u0917\u0930 \u092a\u0941\u0932\u093f\u0938 \u0905\u0927\u0940\u0915\u094d\u0937\u0915 \u0927\u093e\u0930 \u0926\u0947\u0935\u0947\u0928\u094d\u0926\u094d\u0930 \u0938\u093f\u0902\u0939 \u0927\u0941\u0930\u094d\u0935\u0947 \u0928\u0947 \u0921\u0940\u0906\u0907\u091c\u0940 \u0917\u094d\u0930\u093e\u092e\u0940\u0923 \u0915\u093e\u0930\u094d\u092f\u093e\u0932\u092f \u0938\u0947 \u091c\u093e\u0902\u091a \u0915\u0947 \u0932\u093f\u090f \u092d\u0947\u091c\u0947 \u0917\u090f \u092e\u0947\u0930\u0947 \u0906\u0935\u0947\u0926\u0928 \u0915\u0940 \u091c\u093e\u0902\u091a \u0939\u0940 \u0928\u0939\u0940\u0902 \u0915\u0940 \u0939\u0948 \u0935 \u091c\u092c \u092e\u0948\u0928\u0947 \u0906\u0935\u0947\u0926\u0928 \u0915\u0940 \u091c\u093e\u0902\u091a \u0915\u0940 \u091c\u093e\u0928\u0915\u093e\u0930\u0940 \u0932\u0947\u0928\u0947 \u0915\u0947 \u0932\u093f\u090f \u0906\u0930\u091f\u0940\u0906\u0908 \u092a\u094d\u0930\u0947\u0937\u093f\u0924 \u0915\u0940 \u0924\u094b \u0932\u093f\u0916\u0924\u0947 \u0939\u0948\u0902 \u0915\u093f \u0906\u0935\u0947\u0926\u0915 \u092c\u092f\u093e\u0928 \u0926\u0930\u094d\u091c \u0915\u0930\u0928\u0947 \u0928\u0939\u0940\u0902 \u0906 \u0930\u0939\u093e \u0939\u0948, \u092b\u093f\u0930 \u092a\u0941\u0930\u093e\u0928\u0940 \u0926\u093f\u0928\u093e\u0902\u0915 \u092e\u0947 \u092c\u092f\u093e\u0928 \u0926\u0930\u094d\u091c \u0915\u0930\u0928\u0947 \u0915\u093e \u0938\u0942\u091a\u0928\u093e \u092a\u0924\u094d\u0930 \u092d\u0947\u091c\u093e\u0964 \u0939\u0948\u0921\u0915\u093e\u0902\u0938\u091f\u0947\u092c\u0932 \u0926\u094d\u0935\u093f\u0935\u0947\u0926\u0940 \u092d\u0940 \u090f\u090f\u0938\u0906\u0908 \u092e\u0928\u094b\u091c \u091a\u094c\u0939\u093e\u0928 \u0915\u0940 \u0916\u0941\u0932\u0947\u0906\u092e \u092e\u0926\u0926 \u0915\u0930 \u0930\u0939\u0947 \u0939\u0948\u0902 \u091c\u093e\u0902\u091a \u0926\u092c\u093e\u0928\u0947 \u092e\u0947 \u0915\u093f\u0924\u0928\u093e \u0928\u093f\u091c\u0940 \u0932\u093e\u092d \u092e\u093f\u0932 \u0930\u0939\u093e \u0939\u0948 \u0938\u093e\u092c\u093f\u0924 \u0939\u094b \u0917\u092f\u093e \u0915\u093f \u092d\u094d\u0930\u0937\u094d\u091f \u090f\u090f\u0938\u0906\u0908 \u092e\u0928\u094b\u091c \u091a\u094c\u0939\u093e\u0928 \u0928\u0947 \u0938\u092d\u0940 \u0905\u0927\u093f\u0915\u093e\u0930\u093f\u092f\u094b\u0902 \u0915\u094b \u0916\u0930\u0940\u0926 \u0915\u0930 \u0917\u0941\u0932\u093e\u092e \u092c\u0928\u093e \u0932\u093f\u092f\u093e \u0939\u0948 \u20b9 \u0928\u0917\u0930 \u092a\u0941\u0932\u093f\u0938 \u0905\u0927\u0940\u0915\u094d\u0937\u0915 \u0927\u093e\u0930 \u0926\u0947\u0935\u0947\u0928\u094d\u0926\u094d\u0930 \u0938\u093f\u0902\u0939 \u0927\u0941\u0930\u094d\u0935\u0947 \u0928\u093f\u0937\u094d\u092a\u0915\u094d\u0937 \u091c\u093e\u0902\u091a \u0939\u0940 \u0928\u0939\u0940\u0902 \u0915\u0930\u0947\u0902\u0917\u0947 \u091c\u094b \u0906\u0930\u091f\u0940\u0906\u0908 \u0915\u0947 \u0924\u0939\u0924 \u091c\u093e\u0928\u0915\u093e\u0930\u0940 \u092e\u093e\u0902\u0917\u0940 \u0924\u094b \u091c\u093e\u0902\u091a \u0915\u0940 \u0914\u092a\u091a\u093e\u0930\u093f\u0915\u0924\u093e \u0915\u0930 \u0930\u0939\u0947 \u0939\u0948\u0902 \u0928\u093f\u0930\u093e\u0915\u0930\u0923 \u090f\u0915\u092a\u0915\u094d\u0937\u093f\u092f \u0939\u094b\u0917\u093e\u0964 \u0917\u0902\u092d\u0940\u0930 \u092e\u093e\u092e\u0932\u093e \u0939\u0948 \u0938\u0902\u091c\u094d\u091e\u093e\u0928 \u092e\u0947\u0902 \u0932\u0947\u0915\u0930 \u0915\u093e\u0930\u094d\u092f\u0935\u093e\u0939\u0940 \u0915\u0930\u0947\u0902 \u0935 \u090f\u090f\u0938\u0906\u0908 \u092e\u0928\u094b\u091c \u091a\u094c\u0939\u093e\u0928 \u0915\u0947 \u092d\u094d\u0930\u0937\u094d\u091f\u093e\u091a\u093e\u0930 \u092e\u0947 \u092e\u0926\u0926 \u0915\u0930\u0928\u0947 \u0935\u093e\u0932\u0947 \u0928\u0917\u0930 \u092a\u0941\u0932\u093f\u0938 \u0905\u0927\u0940\u0915\u094d\u0937\u0915 \u0927\u093e\u0930 \u0926\u0947\u0935\u0947\u0928\u094d\u0926\u094d\u0930 \u0938\u093f\u0902\u0939 \u0927\u0941\u0930\u094d\u0935\u0947 \u0915\u094b \u092d\u0940 \u091c\u093e\u0902\u091a \u092e\u0947 \u0936\u093e\u092e\u093f\u0932 \u0915\u0930\u0947\u0902 \u090f\u090f\u0938\u0906\u0908 \u092e\u0928\u094b\u091c \u091a\u094c\u0939\u093e\u0928 \u0927\u093e\u0930 \u092e\u0947\u0902 \u0928\u094c\u0915\u0930\u0940 \u0915\u0930\u0928\u0947 \u091c\u093e\u0924\u093e \u0939\u0940 \u0928\u0939\u0940\u0902 \u0939\u0948 \u091c\u094b \u0907\u0928\u094d\u0926\u094c\u0930 \u0936\u0939\u0930 \u092e\u0947\u0902 \u0905\u0930\u093e\u091c\u0915\u0924\u093e \u0917\u0948\u0930 \u0915\u093e\u0928\u0942\u0928\u0940 \u0915\u0943\u0924\u094d\u092f \u0905\u092a\u0930\u093e\u0927 \u0905\u0924\u094d\u092f\u093e\u091a\u093e\u0930 \u092e\u0947 \u0932\u093f\u092a\u094d\u0924 \u0939\u0948 \u0935\u0939 \u092e\u0941\u092b\u094d\u0924 \u0915\u093e \u0935\u0947\u0924\u0928 \u0935 \u0936\u093e\u0938\u0915\u0940\u092f \u0938\u0941\u0935\u093f\u0927\u093e \u0915\u093e \u0932\u093e\u092d \u0932\u0947 \u0930\u0939\u093e \u0939\u0948 \u0928\u0917\u0930 \u092a\u0941\u0932\u093f\u0938 \u0905\u0927\u0940\u0915\u094d\u0937\u0915 \u0927\u093e\u0930 \u0926\u0947\u0935\u0947\u0928\u094d\u0926\u094d\u0930 \u0938\u093f\u0902\u0939 \u0927\u0941\u0930\u094d\u0935\u0947 \u0928\u093f\u0937\u094d\u092a\u0915\u094d\u0937 \u091c\u093e\u0902\u091a \u0939\u0940 \u0928\u0939\u0940\u0902 \u0915\u0930\u0947\u0902\u0917\u0947 \u090f\u090f\u0938\u0906\u0908 \u092e\u0928\u094b\u091c \u091a\u094c\u0939\u093e\u0928 \u0915\u0940 \u092e\u0926\u0926 \u0935 \u092a\u0948\u0930\u0935\u0940 \u0915\u0930 \u0930\u0939\u0947 \u0939\u0948\u0902 \u0907\u0928\u094d\u0939\u0947 \u092d\u0940 \u0906\u0930\u094b\u092a\u0940\u0917\u0923 \u092e\u0947 \u0936\u093e\u092e\u093f\u0932 \u0915\u0930\u0947\u0902 \u0935 \u0939\u0948\u0921\u0915\u093e\u0902\u0938\u091f\u0947\u092c\u0932 \u0926\u094d\u0935\u093f\u0935\u0947\u0926\u0940 \u092d\u0940 \u0906\u0930\u094b\u092a\u0940 \u0939\u0948\u0964"
# # new_complaint_text  =  "Telecommunications >> Mobile Related >> Tariff / Recharge issue / Billing issue of Postpaid\r\n\r\nMobile Number : X4X1X1X4X1\r\nService Provider : Bharat Sanchar Nigam Limited Corporate Office\r\n-----------------------\r\nRespected sir ,\r\nI tried to recharge my BSNL number on 27 jan23, money was deducted, yet I have not received recharge benefits. Details are as follows-\r\nMobile Number - X4X1X1X4X1\r\nOperator Reference Id -X0X0X1X7X4X4X5\r\nAmount-153/-\r\nPls look into the matter and resolve the issue as soon as possible so I can enjoy hassle-free service.\r\n\r\nRegards.\r\nAnshu karn"
# # new_text = "External Affairs >> Others\r\n-----------------------\r\n...\r\nI Danapuneni Sreekanth Rao,paid tution fee to college in New-Zealand in 2009,i paid tution fee but they did not provided any services,i approached Indian embassy who responsible for Indians safety and difficulties in foreign country also not provided anything,iam sending mails to Indian embassy since13 years,in cpgrams portal I sent 7000 grievances to Ministry of External affairs,for my loss Ministry of External affairs,indian embassy,indian Government is responsible,i should get permanent residency from New-Zealand Government and Dollars 913336 NZD equivalent to Indian rupees 5 crores Indian rupees should get from Ministry of External affairs and Indian Government as soon as possible,already 13 years over.please send money to given below Bank ACCOUNT. \r\n\r\n\r\nBank Details: \r\nACCOUNT NAME: Sreekanth Rao Danapuneni \r\n\r\nACCOUNT NO: X2X8X8X9X8X \r\n\r\nIFSC CODE: X-X-X-X-X \r\n\r\nBANK: STATE BANK OF INDIA \r\n\r\nBRANCH:MANTHANI \r\nSTATE. : TELANGANA \r\nCOUNTRY :. INDIA \r\n\r\n\r\nThanks and regards \r\n--------------------------------------- \r\nDanapuneni Sreekanth Rao \r\n+X1X9X3X4X8X0"
# # new_complaint_text_cleaned = clean_text(new_complaint_text)
# # predicted_dept = pipeline.predict([new_complaint_text_cleaned])
# # new_summary = rephrase_text(new_complaint_text_cleaned)
# new_complaint_text = clean_text(new_text)
# # new_complaint_text  = "My INDIAN Passport number: X7X3X4X0 \r\n\r\nMy Immigration Newzealand client number: X3X2X0X4 \r\n\r\n\r\n\r\n\r\n\r\n\r\nI Danapuneni Sreekanth Rao,I paid fee to the college,and I paid taxes to New-Zealand Government in 2009 year.without provided any services how they took my tution fee?all these things because of New-Zealand Government iam facing health problems.why they took my tution fee,without provided anything.due to loss of my 11years I should get permanent residency and compensation of New-Zealand dollars 913336 NZD.all my friends are in good position in jobs.iam mentally faced lot of problems because of New-Zealand Government.So I should get permanent residency and compensation of New-Zealand dollars 913336 NZD from Indian Government. \r\n\r\n\r\n\r\n\r\n\r\nBank Details: \r\nACCOUNT NAME: Sreekanth Rao Danapuneni \r\n\r\nACCOUNT NO: X2X8X8X9X8X \r\n\r\nIFSC CODE: X-X-X-X-X \r\n\r\nBANK: STATE BANK OF INDIA \r\n\r\nBRANCH:MANTHANI \r\nSTATE. : TELANGANA \r\nCOUNTRY :. INDIA \r\n\r\n\r\nThanks and regards \r\n----------------------- \r\nDanapuneni Sreekanth Rao")
# my_model = set_new_predict_pipe()
# dept = my_model.predict([new_complaint_text])
# print("Predicted Department:", dept)
# print(datetime.now()-ini_date) 